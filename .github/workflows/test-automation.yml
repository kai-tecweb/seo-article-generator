name: ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ– CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ»APIãƒ†ã‚¹ãƒˆ
  unit-tests:
    runs-on: ubuntu-latest
    name: ğŸ“‹ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ & API ãƒ†ã‚¹ãƒˆ
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Node.js ${{ env.NODE_VERSION }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci --legacy-peer-deps

    - name: ğŸ—ï¸ Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
      run: npm run build
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-key' }}
        FAL_AI_API_KEY: ${{ secrets.FAL_AI_API_KEY || 'test-key' }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY || 'test-key' }}

    - name: ğŸ§ª Jestãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      run: npm run test -- --coverage --passWithNoTests
      env:
        OPENAI_API_KEY: 'test-key'
        FAL_AI_API_KEY: 'test-key'
        NOTION_API_KEY: 'test-key'

    - name: ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  # E2Eãƒ†ã‚¹ãƒˆ
  e2e-tests:
    runs-on: ubuntu-latest
    name: ğŸ­ E2E ãƒ†ã‚¹ãƒˆ (Playwright)
    needs: unit-tests
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Node.js ${{ env.NODE_VERSION }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci --legacy-peer-deps

    - name: ğŸ­ Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npx playwright install --with-deps

    - name: ğŸ—ï¸ Next.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
      run: npm run build
      env:
        OPENAI_API_KEY: 'test-key'
        FAL_AI_API_KEY: 'test-key'
        NOTION_API_KEY: 'test-key'

    - name: ğŸ® Playwright E2E ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      run: npm run test:e2e
      env:
        OPENAI_API_KEY: 'test-key'
        FAL_AI_API_KEY: 'test-key'
        NOTION_API_KEY: 'test-key'

    - name: ğŸ“¸ Playwright ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    runs-on: ubuntu-latest
    name: ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ª & ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Node.js ${{ env.NODE_VERSION }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci --legacy-peer-deps

    - name: ğŸ” ESLint ã§ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ãƒã‚§ãƒƒã‚¯
      run: npm run lint

    - name: ğŸ’… Prettier ã§ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
      run: npm run format:check

    - name: ğŸ”’ npm audit ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: ğŸ“ TypeScript å‹ãƒã‚§ãƒƒã‚¯
      run: npm run type-check

  # çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆå…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã«å®Ÿè¡Œï¼‰
  integration-tests:
    runs-on: ubuntu-latest
    name: ğŸ”— çµ±åˆãƒ†ã‚¹ãƒˆ & ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™
    needs: [unit-tests, e2e-tests, code-quality]
    if: success()
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Node.js ${{ env.NODE_VERSION }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci --legacy-peer-deps

    - name: ğŸ§ª å…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
      run: npm run test:all
      env:
        OPENAI_API_KEY: 'test-key'
        FAL_AI_API_KEY: 'test-key'
        NOTION_API_KEY: 'test-key'

    - name: ğŸ—ï¸ æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
      run: npm run build
      env:
        OPENAI_API_KEY: 'test-key'
        FAL_AI_API_KEY: 'test-key'
        NOTION_API_KEY: 'test-key'

    - name: âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†é€šçŸ¥
      if: success()
      run: echo "ğŸš€ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†ã§ã™ã€‚"

    - name: âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—é€šçŸ¥
      if: failure()
      run: echo "âŒ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
